## 貧者のためのCoreOSとJenkins
### 技術チーム勉強会 #205

---
#今日話すこと
* 貧者だけどCI環境ほしい
* 貧者なのでお金払いたくない
* Jenkinsたてたcodeは残したい
    * Inflastracture as a Code
    * そこでCoreOS
* 自作ツールのご紹介

---
#(会社ではなく)貧者の問題意識
* おうちでプログラミングしてますか？
* おうちでCIできますか？

---
#おうちにはアレがない
* サーバー
* 上記を置くスペース
* 上記に対する家族の理解

---
#おうちにはアレがない
* メモリ
![100%](https://i.gyazo.com/84b91b8f05fbd08d5967a425378110da.png)
* VirtualBoxとか嫌なんや

---
#おうちにはアレがない
* お金

---
# CI Platforms
* circleci.com($20)
    * 論外
* travis.com($60)
    * 論外
* wercker.com(beta, $0)
    * 抱いて ////
    * けどbeta(いつか有料?)

---
# CI Platforms(考察)
* wercker良さそうですね
    * けどそれじゃ面白くないし
* やっぱVPSにJenkinsを立てよう
    * 修羅

---
# Jenkinsたてたcodeは残したいんや
* CoreOS の cloud-configよさそう
* インスタンスの初期設定をyamlで書ける

---

![100%](https://i.gyazo.com/6a3c3d5cb44c06a261ff3ec4eeb4ca3d.png)

---
# cloud-config
* 最小ではこんな感じ
* これでsshできるdockerインスタンスが手に入る

```
#cloud-config

coreos:
  update:
    reboot-strategy: etcd-lock
users:
  - name: hoshinotsuyoshi
    coreos-ssh-import-github: hoshinotsuyoshi
    groups:
      - sudo
      - docker

```



---
# CoreOSについて
* fleet(Cluster Manamgement)
* etcd(Service Discovery)
* systemd(init.d代替)
* docker(コンテナ仮想化)

---

![100%](https://i.gyazo.com/f050b5ea938c6859b05e7e01362ecf03.png)

---
# CoreOSについて
* systemd
* コンテナ内で全てを動かす
* つまり

---
![350%](https://i.gyazo.com/5735922e586153a2c3773cc8371bcac3.png)

---
#CoreOS良い
*「すべてのぶき／ぼうぐがそうびできる」
* ボス戦向け(本気)っぽい
* すっぴん感あるだけに消費メモリも少ない

---
#CoreOS良い

```
$ free -h
             total       used       free     shared    buffers     cached
Mem:          746M       144M       601M       248K       4.3M        92M
-/+ buffers/cache:        47M       698M
Swap:           0B         0B         0B
```

---
#CoreOS良い
![100%](https://i.gyazo.com/84dc72f69ac77b137a6b5768b52c7fd2.png)
* 本当はfleetとかを駆使してクラスタ向けに使う
* fleet使わない限りcloud-configに書かねばならない
* immutable感
* パッケージマネージャなんてない

---
#VPS選ぶ
* Vultr
* DigitalOcean

---
#Vultr
* あまり流行ってない
* 安い(EC2, DigitalOceanとの比較)
* 近いリージョンある(Tokyo)
* 増えまくるAPI(だが低機能, シンプル
* 転送量課金
* プリペイド
* CoreOSのドキュメント

---
#DigitalOcean
* 流行ってるとおもう
* 近いリージョンある安い
* 速い(Singapore)
* CoreOSのチュートリアルがblogに載ってる

---
# やってみよう(Vultr)
* demo
* プラン(OS/region/memory,etc)選択
* ipxeでCoreOSのバージョン(stable/alpha/beta)選択

---
# やってみよう(Vultr) ipxe
* VPSから見にいかせる場合はhttpのみ
* Vultrで手動の場合はペーストでOK

---
# やってみよう(Vultr) coreos-install
* ログイン後、coreos-install

---
# やってみよう
* こんなかんじ
* Jenkins立てる
  * cloud-config
* 立った

---
# CoreOS良い
* 必要だったもの
  * Dockerfile
  * cloud-config




---
# メモ置き場
---
# CoreOS良い
* 何がいいの？
* "cloud-config"でサーバーまるごとイミュータブルに書ける
* AUTOMATED BUILD REPOSITORY便利

---
# CoreOS良い
* Rakeで使わない時ストップすることで夢が広がる
* `*/5 8-20 * * 1-5`
* `0 1 * * 6` #起動のみ
* 苦しみ
* 貧者のCI

Server-Bootstrap-Vultr　つくった
Ace.js
ActionController::Live
heroku fork
* できないこと is めっちゃおおい
* toolbox
    * 悠然とfedoraのイメージが入り、びびる
* ぜんぶコンテナの中でやる
* docker メモリ制御
* docker cpu share



--link
docker create


