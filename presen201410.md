## 貧者のためのCoreOSとJenkins
### 技術チーム勉強会 #205

---
#今日話すこと
* 貧者だけどCI環境ほしい
* 貧者なのでお金払いたくない
* Jenkinsたてたcodeは残したい
    * Inflastracture as a Code
    * そこでCoreOS
* demo

---
#おうちでの問題
* おうちでCIできますか？

---
#おうちにはアレがない
* サーバー
* 上記を置くスペース
* 上記に対する家族の理解

---
#おうちにはアレがない
* メモリ
![100%](https://i.gyazo.com/84b91b8f05fbd08d5967a425378110da.png)
* VirtualBoxとか嫌なんや

---
#おうちにはアレがない
* お金

---
# CI Platforms
* circleci.com($19/mo~)
    * うっ
* travis.com(pro: $129/mo)
    * うっ
* wercker.com(beta, $0)
    * 抱いて ////
    * けどbeta(いつか有料?)

---
# CI Platforms(考察)
* wercker良さそうですね
    * けどそれじゃ面白くないし
* やっぱVPSにJenkinsを立てよう
    * 修羅の道へ

---
# 修羅の道だが、1つの切なる願い
* Jenkinsたてたcodeは残したいんや
* Inflastracture as a Code
* さくっとやりたい

---
# Jenkinsたてたcodeは残したいんや
* CoreOS の cloud-configよさそう
* インスタンスの初期設定をyamlで書ける

---

![100%](https://i.gyazo.com/6a3c3d5cb44c06a261ff3ec4eeb4ca3d.png)

---
# CoreOSのcloud-config
```
#cloud-config

users:
  - name: hoshinotsuyoshi
    groups:
      - sudo
      - docker
    ssh-authorized-keys:
       - ssh-rsa AAAAB....

```
* 最小ではこんな感じ!
* これでsshできるdockerインスタンスが手に入る!

---
# CoreOSについて

![100% inline](https://i.gyazo.com/f050b5ea938c6859b05e7e01362ecf03.png)

---
# CoreOSについて
* fleet(Cluster Manamgement)
* etcd(Service Discovery)
* systemd(init.d代替, RHEL7から載る)
* docker(コンテナ仮想化のアレ)

↑普通はfleet/etcdが重要ですが、、
今日はsystemd/dockerについてのみ

---
# systemd/dockerでどう動かすの?
* CoreOSのサイトの例で説明
* https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/

---

![80% inline](https://i.gyazo.com/8163167cffe107b9795b3bc8dab91f10.png)

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

### 簡便のためetcd関連は削除しています

---
## Apache httpd service例

```
[unit]
Description=My Advanced Service

After=docker.service
```

## Description : 
## systemctlコマンドを打った時に出てくるサービスの説明
## After: 
## なんのサービスが起動した後にこのサービスが起動するか

---
## Apache httpd service例

```
[Service]
TimeoutStartSec=0



 
```

## TimeoutStartSec :
## タイムアウト。0はタイムアウトしない。

---
## Apache httpd service例

```
ExecStartPre=-/usr/bin/docker kill apache1
ExecStartPre=-/usr/bin/docker rm apache1
ExecStartPre=/usr/bin/docker pull coreos/apache

```

## ExecStartPre :
## ExecStartの前に実行される。
## ここではコンテナ名「apache1」をkillし、削除(rm)、
## docker public repoからイメージ"coreos/apache"をpull
## 「=-」すると終了コードが0以外でも失敗とみなさない

---
## Apache httpd service例

```
ExecStart=/usr/bin/docker run --name apache1 -p 80:80 coreos/apache /usr/sbin/apache2ctl -D FOREGROUND
```

## ExecStart : メインのコマンド。 "systemctl start サービス名" で実行される
## 上記例ではイメージ「coreos/apache」をコンテナ名「apache1」でrunし、
## コンテナの中の話なのでFOREGROUNDを指定している

---
## Apache httpd service例

```
ExecStop=/usr/bin/docker stop apache1
```

## ExecStop : ストップするときのコマンド。 "systemctl stop サービス名" で実行される

---
## これをcloud-configに貼っつければええ!
```
  units:
    - name: httpd.service # 適当に名付ける
      command: start
      runtime: no
      content: |
        [Unit]
        (...前のページの内容をペースト)
```
---
# CoreOS良い
* aptとかyumとかなくてもサービス動く
* コンテナ内で全てを動かす
* つまり

---
![150% inline](https://i.gyazo.com/08c94306b9fb627c2d6d51a9f3177b88.png)

---
# CoreOS良い
* すべてのぶき／ぼうぐがそうびできる」
* ボス戦向け(本気)っぽい
* すっぴん感あるだけに消費メモリも少ない

---
# Vultr/768M plan/CoreOS/すっぴん

```
$ free -h
             total       used       free     shared    buffers     cached
Mem:          746M       144M       601M       248K       4.3M        92M
-/+ buffers/cache:        47M       698M
Swap:           0B         0B         0B
```

---
#CoreOS良い ここまでのまとめ
* 本当はクラスタ向けのOSなのだが
* fleet使わない限りcloud-configに書く
    * immutable感
    * パッケージマネージャなんてない

---
#VPS選ぶ
* DigitalOcean
* Vultr

---
#DigitalOcean
* min: $5/1month, $0.007$/1h
* 近いリージョンある(Singapore)
* 転送量課金
* paypal選べる
* API
* CoreOSのチュートリアルがblogに載ってて、良い

---
#Vultr
* min: $5/1month, $0.007$/1h
* 近いリージョンある(Tokyo)
* 転送量課金
* プリペイド
* API(だが低機能, シンプル

---
#さくらVPS
* min: 934yen/1month
* 近いリージョン
* 転送量課金なし(すばらしい)
* すいません調べてないです

---
#その他クラウド系
* ちゃんと調べてないですすみません
* 高いイメージある

---
# demo
## DigitalOceanでcoreos立てる
* プラン選択(メモリ/転送量/HDD)
* リージョン選択
* userdata
    - cloud-config を貼る!
* CoreOSのバージョンを指定
    - alpha/beta/stable
* ここまで一瞬、あとは待つだけ

---
## プラン選択

![100% inline](https://i.gyazo.com/898aae945fe500193d4d0ddf23f70971.png)

---
## リージョン選択 / cloud-configペタリ

![100% inline](https://i.gyazo.com/e5e0bc93e618fe6146e865ce661a3e8e.png)

##### memo: https://gist.github.com/hoshinotsuyoshi/8d3dc38d50c61c1b6cd3

---
## CoreOSのバージョンを指定 / 鍵を指定

![100% inline](https://i.gyazo.com/cb455ee311218d41dfd7bdb048b448b6.png)

#### DigitalOcean編は以上

---
# demo
## Vultrでcoreos立てる
* 事前準備:ipxe用意しとく
* プラン選択リージョン選択
* coreos-installコマンド + reboot

---
## 事前準備:ipxe用意しとく(説明割愛、、CoreOSのサイト参照)

![100% inline](https://i.gyazo.com/bbcd3b31abd1d8f1418bfe100572fc88.png)

---
## プラン選択リージョン選択

![100% inline](https://i.gyazo.com/988c4b9141041fb331f0280a13261954.png)

---
## さっきのipxe選ぶ, buy

![100% inline](https://gyazo.com/0ec343f93ff478b44b16557e3b22003a.png)

---
## ipアドレスが決まるまで数十秒待つ

![100% inline](https://i.gyazo.com/925a7f9fae700323dd663a1a466e5a38.png)

---
## coreos-installコマンド + reboot

```
$ ssh core@IPアドレス

cd ~ && \
curl -L https://gistかなんかに貼っとく/cloud-config.yaml > ~/config &&  \
sudo coreos-install -d /dev/vda -C alpha -c ~/config -o '' && \
sudo mount -o subvol=root /dev/vda9 /mnt/ && \
sudo reboot

```

##### 「-o '' 」しないとできなかった（はまった）

#### Vultr編は以上

---
## hello my service!

### もしかして：jenkinsじゃなくても任意のサービスが起動できる!

---
## systemd : 叩くと楽しいかもしれないコマンド

* sudo systemctl service hoge
    * サービスの状態がわかる
* systemd-analyze plot > file.svg

---
# jenkins立てるのに必要だったもの
* docker image
* cloud-config

#### https://github.com/hoshinotsuyoshi/dind-jenkins
#### https://github.com/hoshinotsuyoshi/dind-jenkins-auto-build-ruby
#### https://gist.github.com/hoshinotsuyoshi/8d3dc38d50c61c1b6cd3

---
# docker と github

* githubとdocker hub連携させた
* 「AUTOMATED BUILD REPOSITORY」というのが便利
* 指定のブランチにプッシュすると自動的にビルドしてくれる
* おうちのパソコンでビルドしなくていい

---
# 今回作ったdocker image(1)

* jenkinsとdockerが動くイメージを作成
    * (dockerの中でdockerが動く」は個人的趣味)
    * jenkinsでdocker buildのテストをしたいから
    * `FROM jpetazzo/dind`

#### https://github.com/hoshinotsuyoshi/dind-jenkins

---
# 今回作ったdocker image(2)

* (1)のイメージをFROMしrubyを入れたイメージを作成
* 「ONBUILD」 使ってみた
    * 子ビルドのビルド時のコマンドを指定できる
* `ONBUILD ADD config.xml`
* template methodっぽい

#### https://github.com/hoshinotsuyoshi/dind-jenkins-auto-build-ruby

---
# 今回作ったdocker image(3)
* (2)のイメージをFROM
    * CoreOS起動時にjenkinsの設定ファイルを作成

---
# 所感

サンデープログラマはherokuとかで
起動をスクリプト化しておけば

```
00 00 * * 6 rake:start_jenkins
59 23 * * 7 rake:kill_jenkins
```

さらに節約できると思いました

---
# 終わり


