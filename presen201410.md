## 貧者のためのCoreOSとJenkins
### 技術チーム勉強会 #205

---
#今日話すこと
* 貧者だけどCI環境ほしい
* 貧者なのでお金払いたくない
* Jenkinsたてたcodeは残したい
    * Inflastracture as a Code
    * そこでCoreOS
* 自作ツールのご紹介

---
#おうちでの問題
* おうちでCIできますか？

---
#おうちにはアレがない
* サーバー
* 上記を置くスペース
* 上記に対する家族の理解

---
#おうちにはアレがない
* メモリ
![100%](https://i.gyazo.com/84b91b8f05fbd08d5967a425378110da.png)
* VirtualBoxとか嫌なんや

---
#おうちにはアレがない
* お金

---
# CI Platforms
* circleci.com($20)
    * 論外
* travis.com($60)
    * 論外
* wercker.com(beta, $0)
    * 抱いて ////
    * けどbeta(いつか有料?)

---
# CI Platforms(考察)
* wercker良さそうですね
    * けどそれじゃ面白くないし
* やっぱVPSにJenkinsを立てよう
    * 修羅の道へ

---
# 修羅の道だが、1つの切なる願い
* Jenkinsたてたcodeは残したいんや
* Inflastracture as a Code
* さくっとやりたい

---
# Jenkinsたてたcodeは残したいんや
* CoreOS の cloud-configよさそう
* インスタンスの初期設定をyamlで書ける

---

![100%](https://i.gyazo.com/6a3c3d5cb44c06a261ff3ec4eeb4ca3d.png)

---
# CoreOSのcloud-config
```
#cloud-config

users:
  - name: hoshinotsuyoshi
    coreos-ssh-import-github: hoshinotsuyoshi
    groups:
      - sudo
      - docker

```
* 最小ではこんな感じ!
* これでsshできるdockerインスタンスが手に入る!
* `coreos-ssh-import-github`べんり

---
# CoreOSについて

![100% inline](https://i.gyazo.com/f050b5ea938c6859b05e7e01362ecf03.png)

---
# CoreOSについて
* fleet(Cluster Manamgement)
* etcd(Service Discovery)
* systemd(init.d代替, RHEL7から載る)
* docker(コンテナ仮想化のアレ)

↑普通はfleet/etcdが重要ですが、、
今日はsystemd/dockerについてのみ

---
# systemd/dockerでどう動かすの?
* CoreOSのサイトの例で説明
* https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/

---

![80% inline](https://i.gyazo.com/8163167cffe107b9795b3bc8dab91f10.png)

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

### 簡便のためetcd関連は削除しています

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

## Description : systemctlコマンドを打った時に出てくるサービスの説明
## After: なんのサービスが起動した後にこのサービスが起動するか

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

## TimeoutStartSec : タイムアウト。0はタイムアウトしない。

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

## ExecStartPre : ExecStartの前に実行される。
## 上記例ではコンテナ名「apache1」をkillし、削除(rm)し、
## docker public repoからイメージ"coreos/apache"をpullする
## `=-`すると終了コードが0以外でも失敗とみなさない

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

## ExecStart : メインのコマンド。 "systemctl start サービス名" で実行される
## 上記例ではイメージ「coreos/apache」をコンテナ名「apache1」でrunし、
## コンテナの中の話なのでFOREGROUNDを指定している

---
## Apache httpd service例

![120% inline](https://i.gyazo.com/2dc756b6d1b192845c3b8ec7571f821f.png)

## ExecStop : ストップするときのコマンド。 "systemctl stop サービス名" で実行される

---
## これをcloud-configに貼っつければええ!
```
  units:
    - name: httpd.service # 適当に名付ける　
      command: start
      runtime: no
      content: |
        [Unit]
        (...前のページの内容をペースト)
```
---
# CoreOS良い
* aptとかyumとかなくてもサービス動く
* コンテナ内で全てを動かす
* つまり

---
![350% inline](https://i.gyazo.com/5735922e586153a2c3773cc8371bcac3.png)

---
# CoreOS良い
* すべてのぶき／ぼうぐがそうびできる」
* ボス戦向け(本気)っぽい
* すっぴん感あるだけに消費メモリも少ない

---
# CoreOS良い

```
$ free -h
             total       used       free     shared    buffers     cached
Mem:          746M       144M       601M       248K       4.3M        92M
-/+ buffers/cache:        47M       698M
Swap:           0B         0B         0B
```

---
#CoreOS良い ここまでのまとめ
![100%](https://i.gyazo.com/84dc72f69ac77b137a6b5768b52c7fd2.png)
* 本当はクラスタ向けのOS
* fleet使わない限りcloud-configに書く
    * immutable感
    * パッケージマネージャなんてない

---
#VPS選ぶ
* DigitalOcean
* Vultr

---
#DigitalOcean
* min: $5/1month, $0.007$/1h
* 近いリージョンある(Singapore)
* 転送量課金
* CoreOSのチュートリアルがblogに載ってて、良い

---
#Vultr
* min: $5/1month, $0.007$/1h
* 近いリージョンある(Tokyo)
* 転送量課金
* プリペイド
* 増えまくるAPI(だが低機能, シンプル

---
#さくらVPS
* min: 980yen?/1month
* 近いリージョン
* 転送量課金なし(すばらしい)
* すいません調べてないです

---
#その他クラウド系
* ちゃんと調べてないですすみません
* 高いイメージある

---
# 2分demo
## DigitalOceanでcoreos立てる
* プラン選択
    - region/memory
* ipxe指定, boot
    - CoreOSのバージョンを指定
        - stable/alpha/beta
* coreos-install
    - このときcloud-config

---
# 2分demo - ipxe
* VPSから見にいかせる場合はhttpのみ
* Vultrで手動の場合はペーストでOK

---
# やってみよう(Vultr) coreos-install
* ログイン後、coreos-install

---
# やってみよう
* こんなかんじ
* Jenkins立てる
  * cloud-config
* 立った

---
# CoreOS良い
* 必要だったもの
  * Dockerfile
  * cloud-config




---
# メモ置き場
---
# CoreOS良い
* 何がいいの？
* "cloud-config"でサーバーまるごとイミュータブルに書ける
* AUTOMATED BUILD REPOSITORY便利

---
# CoreOS良い
* Rakeで使わない時ストップすることで夢が広がる
* `*/5 8-20 * * 1-5`
* `0 1 * * 6` #起動のみ
* 苦しみ
* 貧者のCI

Server-Bootstrap-Vultr　つくった
Ace.js
ActionController::Live
heroku fork
* できないこと is めっちゃおおい
* toolbox
    * 悠然とfedoraのイメージが入り、びびる
* ぜんぶコンテナの中でやる
* docker メモリ制御
* docker cpu share



--link
docker create


